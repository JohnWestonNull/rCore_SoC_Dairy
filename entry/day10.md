# 7月6日，Day 10

正式开始 lab 4, 应该很快就会完成整个任务了.

#### rCore 的调度模型

进程只负责控制**内存映射**, 其他均交给全局的单 `PROCESSOR` 执行, 这让设计变得简单但是未来修改起来可能比较困难.

目前我不太明白的是这种模型未来如何支持多核运行.

#### 内核栈的用途

用于存储各个线程在中断发生时的**上下文**, 为了让线程时刻能找到内核栈的位置, 我们将内核栈的地址在启动线程时存储到 `sscratch` 寄存器中, 这样就确保了线程在中断发生时能及时存储自己的上下文.

**中断发生的过程:**

- 预留一段空间作为内核栈
- 运行线程时，在 `sscratch` 寄存器中保存内核栈指针  
- 如果线程遇到中断，则从将 `Context` 压入 `sscratch` 指向的栈中（`Context` 的地址为 `sscratch - size_of::()`），同时用新的栈地址来替换 `sp`（此时 `sp` 也会被复制到 `a0` 作为 `handle_interrupt` 的参数）  
- 从中断中返回时（`__restore` 时），`a0` 应指向**被压在内核栈中的 `Context`**。此时出栈 `Context` 并且将栈顶保存到 `sscratch` 中

#### 考虑完善之前 lab 的测试函数

rCore-Tutorial 的单元测试和集成测试相当不完善, 但是我不知道怎么去改善, 准备先添加一些普通函数来确保之前的程序没有问题, 之后等自己的技术精进之后再考虑添加真正的单元测试.